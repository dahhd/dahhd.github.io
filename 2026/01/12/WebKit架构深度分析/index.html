<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="始于俗世，心存善念"><title>WebKit 内核架构深度分析 | 四公子的剑</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">WebKit 内核架构深度分析</h1><a id="logo" href="/.">四公子的剑</a><p class="description">This is my site, welcome you!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">WebKit 内核架构深度分析</h1><div class="post-meta">2026-01-12<span> | </span><span class="category"><a href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span></div><div class="post-content"><h1 id="WebKit-内核架构深度分析"><a href="#WebKit-内核架构深度分析" class="headerlink" title="WebKit 内核架构深度分析"></a>WebKit 内核架构深度分析</h1><blockquote>
<p>本文档基于 WebKit 源码仓库进行深度分析，专为 iOS 开发工程师编写，帮助你深入理解 WebKit 内核的底层原理。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#1-%E6%A6%82%E8%BF%B0%E4%BB%80%E4%B9%88%E6%98%AF-webkit">概述：什么是 WebKit</a></li>
<li><a href="#2-%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%E6%9E%B6%E6%9E%84">核心模块架构</a></li>
<li><a href="#3-dom-%E6%A0%91%E4%B8%8E%E8%8A%82%E7%82%B9%E7%B3%BB%E7%BB%9F">DOM 树与节点系统</a></li>
<li><a href="#4-%E6%B8%B2%E6%9F%93%E6%B5%81%E6%B0%B4%E7%BA%BF">渲染流水线</a></li>
<li><a href="#5-javascript-%E5%BC%95%E6%93%8E-javascriptcore">JavaScript 引擎 (JavaScriptCore)</a></li>
<li><a href="#6-%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%9E%B6%E6%9E%84">多进程架构</a></li>
<li><a href="#7-wkwebview-%E4%B8%8E-ios-%E5%BC%80%E5%8F%91">WKWebView 与 iOS 开发</a></li>
<li><a href="#8-%E7%BD%91%E7%BB%9C%E4%B8%8E%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD">网络与资源加载</a></li>
<li><a href="#9-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F">事件处理系统</a></li>
<li><a href="#10-css-%E6%A0%B7%E5%BC%8F%E7%B3%BB%E7%BB%9F">CSS 样式系统</a></li>
</ol>
<hr>
<h2 id="1-概述：什么是-WebKit"><a href="#1-概述：什么是-WebKit" class="headerlink" title="1. 概述：什么是 WebKit"></a>1. 概述：什么是 WebKit</h2><h3 id="1-1-WebKit-的身份"><a href="#1-1-WebKit-的身份" class="headerlink" title="1.1 WebKit 的身份"></a>1.1 WebKit 的身份</h3><p>WebKit 是一个<strong>开源的浏览器引擎</strong>，由苹果公司主导开发和维护。在 iOS 设备上，<strong>所有浏览器都必须使用 WebKit</strong> —— 包括 Safari、Chrome、Firefox 的 iOS 版本。这意味着作为 iOS 开发者，理解 WebKit 对于处理任何 Web 内容至关重要。</p>
<h3 id="1-2-源码目录结构总览"><a href="#1-2-源码目录结构总览" class="headerlink" title="1.2 源码目录结构总览"></a>1.2 源码目录结构总览</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">WebKit/</span><br><span class="line">├── Source/                    # 核心源代码目录</span><br><span class="line">│   ├── WebCore/              # 渲染引擎核心（最重要）</span><br><span class="line">│   ├── JavaScriptCore/       # JavaScript 引擎</span><br><span class="line">│   ├── WebKit/               # 跨进程通信和 API 层</span><br><span class="line">│   ├── WTF/                  # Web Template Framework - 基础工具库</span><br><span class="line">│   ├── bmalloc/              # 内存分配器</span><br><span class="line">│   └── WebKitLegacy/         # 旧版 API (UIWebView)</span><br><span class="line">├── Configurations/           # 构建配置</span><br><span class="line">└── WebKitLibraries/          # 第三方库</span><br></pre></td></tr></table></figure>

<h3 id="1-3-iOS-开发视角"><a href="#1-3-iOS-开发视角" class="headerlink" title="1.3 iOS 开发视角"></a>1.3 iOS 开发视角</h3><p>从 iOS 开发的角度，你可以这样理解：</p>
<table>
<thead>
<tr>
<th>WebKit 组件</th>
<th>iOS 开发类比</th>
</tr>
</thead>
<tbody><tr>
<td><code>WKWebView</code></td>
<td>类似于 <code>UIImageView</code>，是用户界面层</td>
</tr>
<tr>
<td><code>WebCore</code></td>
<td>类似于 <code>UIKit</code> 框架，负责渲染和布局</td>
</tr>
<tr>
<td><code>JavaScriptCore</code></td>
<td>类似于 Swift Runtime，负责执行代码</td>
</tr>
<tr>
<td><code>WTF</code></td>
<td>类似于 Foundation 框架，提供基础工具</td>
</tr>
</tbody></table>
<hr>
<h2 id="2-核心模块架构"><a href="#2-核心模块架构" class="headerlink" title="2. 核心模块架构"></a>2. 核心模块架构</h2><h3 id="2-1-WTF-Web-Template-Framework"><a href="#2-1-WTF-Web-Template-Framework" class="headerlink" title="2.1 WTF (Web Template Framework)"></a>2.1 WTF (Web Template Framework)</h3><p><strong>路径</strong>: <code>Source/WTF/wtf/</code></p>
<p>WTF 是 WebKit 的”基础设施层”，提供了类似于 C++ 标准库但更高效的实现。</p>
<h4 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wtf/</span><br><span class="line">├── Vector.h           # 类似 std::vector，但性能更好</span><br><span class="line">├── HashMap.h          # 哈希表实现</span><br><span class="line">├── RefPtr.h           # 智能指针，类似 Swift 的 ARC</span><br><span class="line">├── RefCounted.h       # 引用计数基类</span><br><span class="line">├── String.h           # 字符串类</span><br><span class="line">├── URL.h              # URL 解析和处理</span><br><span class="line">├── Threading.h        # 线程管理</span><br><span class="line">├── RunLoop.h          # 运行循环，类似 CFRunLoop</span><br><span class="line">├── MainThread.h       # 主线程工具</span><br><span class="line">└── WorkQueue.h        # 工作队列，类似 DispatchQueue</span><br></pre></td></tr></table></figure>

<h4 id="iOS-开发类比"><a href="#iOS-开发类比" class="headerlink" title="iOS 开发类比"></a>iOS 开发类比</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WTF::RefPtr 类似 Swift 的强引用</span></span><br><span class="line"><span class="comment">// Source/WTF/wtf/RefPtr.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">RefPtr</span> &#123;</span><br><span class="line">    T* m_ptr;</span><br><span class="line">    <span class="comment">// 自动管理引用计数，类似 Swift ARC</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// iOS 中的类比：</span></span><br><span class="line"><span class="comment">// let view: UIView = UIView()  // Swift ARC 自动管理</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WTF::Vector 类似 Swift Array</span></span><br><span class="line"><span class="comment">// Source/WTF/wtf/Vector.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">Vector</span> &#123;</span><br><span class="line">    <span class="comment">// 动态数组，自动扩容</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// iOS 类比：</span></span><br><span class="line"><span class="comment">// var array: [Int] = []</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-WebCore-渲染引擎核心"><a href="#2-2-WebCore-渲染引擎核心" class="headerlink" title="2.2 WebCore - 渲染引擎核心"></a>2.2 WebCore - 渲染引擎核心</h3><p><strong>路径</strong>: <code>Source/WebCore/</code></p>
<p>WebCore 是 WebKit 的”心脏”，负责：</p>
<ul>
<li>解析 HTML&#x2F;CSS</li>
<li>构建 DOM 树</li>
<li>计算样式和布局</li>
<li>执行渲染</li>
</ul>
<h4 id="核心子目录"><a href="#核心子目录" class="headerlink" title="核心子目录"></a>核心子目录</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WebCore/</span><br><span class="line">├── dom/              # DOM 节点实现</span><br><span class="line">├── html/             # HTML 元素实现</span><br><span class="line">├── css/              # CSS 解析和样式</span><br><span class="line">├── rendering/        # 渲染树和绘制</span><br><span class="line">├── layout/           # 布局计算</span><br><span class="line">├── page/             # Page、Frame、Window 等概念</span><br><span class="line">├── loader/           # 资源加载</span><br><span class="line">├── platform/         # 平台抽象层</span><br><span class="line">├── bindings/         # JS 绑定</span><br><span class="line">├── animation/        # 动画系统</span><br><span class="line">└── style/            # 样式计算</span><br></pre></td></tr></table></figure>

<h3 id="2-3-JavaScriptCore-JS-引擎"><a href="#2-3-JavaScriptCore-JS-引擎" class="headerlink" title="2.3 JavaScriptCore - JS 引擎"></a>2.3 JavaScriptCore - JS 引擎</h3><p><strong>路径</strong>: <code>Source/JavaScriptCore/</code></p>
<p>JavaScriptCore 是苹果的 JavaScript 引擎，在 iOS 上可以直接使用（通过 JavaScriptCore.framework）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">JavaScriptCore/</span><br><span class="line">├── API/              # 公开 API（iOS 可用）</span><br><span class="line">├── runtime/          # JS 运行时（对象、函数等）</span><br><span class="line">├── parser/           # 代码解析</span><br><span class="line">├── bytecode/         # 字节码</span><br><span class="line">├── interpreter/      # 解释器</span><br><span class="line">├── jit/              # JIT 编译器</span><br><span class="line">├── dfg/              # DFG 优化编译器</span><br><span class="line">├── ftl/              # FTL 高级优化编译器</span><br><span class="line">└── heap/             # 垃圾回收</span><br></pre></td></tr></table></figure>

<h3 id="2-4-WebKit-WebKit2"><a href="#2-4-WebKit-WebKit2" class="headerlink" title="2.4 WebKit (WebKit2)"></a>2.4 WebKit (WebKit2)</h3><p><strong>路径</strong>: <code>Source/WebKit/</code></p>
<p>这是现代 WebKit 架构，实现了多进程模型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WebKit/</span><br><span class="line">├── UIProcess/        # UI 进程（你的 App 进程）</span><br><span class="line">├── WebProcess/       # Web 内容进程（渲染进程）</span><br><span class="line">├── NetworkProcess/   # 网络进程</span><br><span class="line">├── GPUProcess/       # GPU 进程</span><br><span class="line">├── Shared/           # 跨进程共享代码</span><br><span class="line">└── Platform/         # 平台相关实现</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-DOM-树与节点系统"><a href="#3-DOM-树与节点系统" class="headerlink" title="3. DOM 树与节点系统"></a>3. DOM 树与节点系统</h2><h3 id="3-1-Node-所有节点的基类"><a href="#3-1-Node-所有节点的基类" class="headerlink" title="3.1 Node - 所有节点的基类"></a>3.1 Node - 所有节点的基类</h3><p><strong>路径</strong>: <code>Source/WebCore/dom/Node.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node 是 DOM 树中所有节点的基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span> : <span class="keyword">public</span> EventTarget &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">NodeType</span> &#123;</span><br><span class="line">        ELEMENT_NODE = <span class="number">1</span>,           <span class="comment">// 元素节点，如 &lt;div&gt;</span></span><br><span class="line">        ATTRIBUTE_NODE = <span class="number">2</span>,         <span class="comment">// 属性节点（已废弃）</span></span><br><span class="line">        TEXT_NODE = <span class="number">3</span>,              <span class="comment">// 文本节点</span></span><br><span class="line">        COMMENT_NODE = <span class="number">8</span>,           <span class="comment">// 注释节点</span></span><br><span class="line">        DOCUMENT_NODE = <span class="number">9</span>,          <span class="comment">// Document 节点</span></span><br><span class="line">        DOCUMENT_FRAGMENT_NODE = <span class="number">11</span> <span class="comment">// DocumentFragment</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 树结构导航</span></span><br><span class="line">    <span class="function">ContainerNode* <span class="title">parentNode</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Node* <span class="title">firstChild</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Node* <span class="title">lastChild</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Node* <span class="title">nextSibling</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Node* <span class="title">previousSibling</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 所属 Document</span></span><br><span class="line">    <span class="function">Document&amp; <span class="title">document</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 渲染对象</span></span><br><span class="line">    <span class="function">RenderObject* <span class="title">renderer</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比"><a href="#iOS-类比" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node 类似于 UIView 在视图层次中的角色</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UIView</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> superview: <span class="type">UIView</span>?        <span class="comment">// 类似 parentNode()</span></span><br><span class="line">    <span class="keyword">var</span> subviews: [<span class="type">UIView</span>]        <span class="comment">// 类似 childNodes</span></span><br><span class="line">    <span class="comment">// UIView 也是树形结构</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-继承层次"><a href="#3-2-继承层次" class="headerlink" title="3.2 继承层次"></a>3.2 继承层次</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">EventTarget           # 事件目标基类</span><br><span class="line">    └── Node          # 所有 DOM 节点的基类</span><br><span class="line">        ├── Document      # 整个文档</span><br><span class="line">        ├── Element       # 元素节点</span><br><span class="line">        │   ├── HTMLElement   # HTML 元素</span><br><span class="line">        │   │   ├── HTMLDivElement</span><br><span class="line">        │   │   ├── HTMLInputElement</span><br><span class="line">        │   │   └── ...</span><br><span class="line">        │   └── SVGElement    # SVG 元素</span><br><span class="line">        ├── CharacterData     # 字符数据</span><br><span class="line">        │   ├── Text          # 文本节点</span><br><span class="line">        │   └── Comment       # 注释节点</span><br><span class="line">        └── DocumentFragment  # 文档片段</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Document-文档对象"><a href="#3-3-Document-文档对象" class="headerlink" title="3.3 Document - 文档对象"></a>3.3 Document - 文档对象</h3><p><strong>路径</strong>: <code>Source/WebCore/dom/Document.h</code></p>
<p>Document 是整个网页的根节点，管理所有的 DOM 节点。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Document</span> : <span class="keyword">public</span> ContainerNode, <span class="keyword">public</span> TreeScope &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 创建元素</span></span><br><span class="line">    <span class="function">Ref&lt;Element&gt; <span class="title">createElement</span><span class="params">(<span class="type">const</span> AtomString&amp; tagName)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找元素</span></span><br><span class="line">    <span class="function">Element* <span class="title">getElementById</span><span class="params">(<span class="type">const</span> AtomString&amp; id)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 访问特殊元素</span></span><br><span class="line">    <span class="function">HTMLBodyElement* <span class="title">body</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">HTMLHeadElement* <span class="title">head</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 样式表管理</span></span><br><span class="line">    <span class="function">StyleResolver&amp; <span class="title">styleResolver</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 页面生命周期</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">prepareForDestruction</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-1"><a href="#iOS-类比-1" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Document 类似于 UIWindow 或整个视图控制器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UIViewController</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> view: <span class="type">UIView</span>!  <span class="comment">// 类似 document.body</span></span><br><span class="line">    <span class="comment">// 管理整个视图层次</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-Element-元素节点"><a href="#3-4-Element-元素节点" class="headerlink" title="3.4 Element - 元素节点"></a>3.4 Element - 元素节点</h3><p><strong>路径</strong>: <code>Source/WebCore/dom/Element.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Element</span> : <span class="keyword">public</span> ContainerNode &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 属性操作</span></span><br><span class="line">    <span class="function"><span class="type">const</span> AtomString&amp; <span class="title">getAttribute</span><span class="params">(<span class="type">const</span> QualifiedName&amp;)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setAttribute</span><span class="params">(<span class="type">const</span> QualifiedName&amp;, <span class="type">const</span> AtomString&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 类名操作</span></span><br><span class="line">    <span class="function">DOMTokenList&amp; <span class="title">classList</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 样式</span></span><br><span class="line">    <span class="function">CSSStyleDeclaration&amp; <span class="title">style</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 布局信息</span></span><br><span class="line">    <span class="function">IntRect <span class="title">boundingClientRect</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Shadow DOM</span></span><br><span class="line">    <span class="function">ShadowRoot* <span class="title">shadowRoot</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">ShadowRoot&amp; <span class="title">attachShadow</span><span class="params">(ShadowRootMode)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-实际代码示例：节点创建流程"><a href="#3-5-实际代码示例：节点创建流程" class="headerlink" title="3.5 实际代码示例：节点创建流程"></a>3.5 实际代码示例：节点创建流程</h3><p>当浏览器解析 HTML 时：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;container&quot;</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>WebKit 内部的处理流程（简化版）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建 HTMLDivElement</span></span><br><span class="line"><span class="comment">// Source/WebCore/html/HTMLDivElement.cpp</span></span><br><span class="line"><span class="function">Ref&lt;HTMLDivElement&gt; <span class="title">HTMLDivElement::create</span><span class="params">(Document&amp; document)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">adoptRef</span>(*<span class="keyword">new</span> <span class="built_in">HTMLDivElement</span>(HTMLNames::divTag, document));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 设置属性</span></span><br><span class="line">element-&gt;<span class="built_in">setAttribute</span>(HTMLNames::idAttr, <span class="string">&quot;container&quot;</span>_s);</span><br><span class="line">element-&gt;<span class="built_in">setAttribute</span>(HTMLNames::classAttr, <span class="string">&quot;box&quot;</span>_s);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 添加文本子节点</span></span><br><span class="line"><span class="keyword">auto</span> textNode = document.<span class="built_in">createTextNode</span>(<span class="string">&quot;Hello&quot;</span>_s);</span><br><span class="line">element-&gt;<span class="built_in">appendChild</span>(textNode);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-渲染流水线"><a href="#4-渲染流水线" class="headerlink" title="4. 渲染流水线"></a>4. 渲染流水线</h2><h3 id="4-1-渲染流水线概述"><a href="#4-1-渲染流水线概述" class="headerlink" title="4.1 渲染流水线概述"></a>4.1 渲染流水线概述</h3><p>WebKit 的渲染流程（Rendering Pipeline）可以分为以下阶段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">HTML/CSS/JS 输入</span><br><span class="line">      ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   DOM 树构建     │  ← 解析 HTML，创建 Node 对象</span><br><span class="line">└─────────────────┘</span><br><span class="line">      ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│  样式计算 Style  │  ← 计算每个元素的最终样式</span><br><span class="line">└─────────────────┘</span><br><span class="line">      ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   布局 Layout    │  ← 计算每个元素的位置和大小</span><br><span class="line">└─────────────────┘</span><br><span class="line">      ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│  分层 Layering   │  ← 将内容分到不同的图层</span><br><span class="line">└─────────────────┘</span><br><span class="line">      ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   绘制 Paint     │  ← 生成绘制指令</span><br><span class="line">└─────────────────┘</span><br><span class="line">      ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│  合成 Composite  │  ← GPU 合成最终画面</span><br><span class="line">└─────────────────┘</span><br><span class="line">      ↓</span><br><span class="line">    屏幕显示</span><br></pre></td></tr></table></figure>

<h3 id="4-2-RenderObject-渲染对象基类"><a href="#4-2-RenderObject-渲染对象基类" class="headerlink" title="4.2 RenderObject - 渲染对象基类"></a>4.2 RenderObject - 渲染对象基类</h3><p><strong>路径</strong>: <code>Source/WebCore/rendering/RenderObject.h</code></p>
<p>每个需要显示的 DOM 节点都会创建对应的 RenderObject。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RenderObject</span> : <span class="keyword">public</span> CachedImageClient &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 渲染对象类型</span></span><br><span class="line">    <span class="keyword">enum class</span> <span class="title class_">Type</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">        BlockFlow,    <span class="comment">// 块级流式布局</span></span><br><span class="line">        Inline,       <span class="comment">// 行内元素</span></span><br><span class="line">        Image,        <span class="comment">// 图片</span></span><br><span class="line">        Text,         <span class="comment">// 文本</span></span><br><span class="line">        Table,        <span class="comment">// 表格</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关联的 DOM 节点</span></span><br><span class="line">    <span class="function">Node* <span class="title">node</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关联的样式</span></span><br><span class="line">    <span class="function"><span class="type">const</span> RenderStyle&amp; <span class="title">style</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绘制</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">paint</span><span class="params">(PaintInfo&amp;, <span class="type">const</span> LayoutPoint&amp;)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 布局</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">layout</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-2"><a href="#iOS-类比-2" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RenderObject 类似于 CALayer</span></span><br><span class="line"><span class="comment">// DOM Node : RenderObject ≈ UIView : CALayer</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CALayer</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">draw</span>(<span class="params">in</span> <span class="params">ctx</span>: <span class="type">CGContext</span>)  <span class="comment">// 类似 paint()</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">layoutSublayers</span>()        <span class="comment">// 类似 layout()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-RenderTree-vs-DOM-Tree"><a href="#4-3-RenderTree-vs-DOM-Tree" class="headerlink" title="4.3 RenderTree vs DOM Tree"></a>4.3 RenderTree vs DOM Tree</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DOM Tree (逻辑结构)              Render Tree (渲染结构)</span><br><span class="line">═══════════════════              ═══════════════════════</span><br><span class="line"></span><br><span class="line">Document                         RenderView</span><br><span class="line">    │                                │</span><br><span class="line">    └── &lt;html&gt;                       └── RenderBlock (html)</span><br><span class="line">        │                                    │</span><br><span class="line">        ├── &lt;head&gt;                           │ (head 不渲染)</span><br><span class="line">        │   └── &lt;style&gt;                      │</span><br><span class="line">        │                                    │</span><br><span class="line">        └── &lt;body&gt;                           └── RenderBody</span><br><span class="line">            │                                        │</span><br><span class="line">            ├── &lt;div&gt;                                ├── RenderBlock</span><br><span class="line">            │   └── &quot;Hello&quot;                          │   └── RenderText</span><br><span class="line">            │                                        │</span><br><span class="line">            └── &lt;span style=&quot;display:none&quot;&gt;          │ (display:none 不创建渲染对象)</span><br><span class="line">                └── &quot;Hidden&quot;                         │</span><br></pre></td></tr></table></figure>

<p><strong>重要区别：</strong></p>
<ul>
<li>不是所有 DOM 节点都有 RenderObject（如 <code>display: none</code>）</li>
<li>一个 DOM 节点可能生成多个渲染对象（如列表项的标记）</li>
</ul>
<h3 id="4-4-布局计算-Layout"><a href="#4-4-布局计算-Layout" class="headerlink" title="4.4 布局计算 (Layout)"></a>4.4 布局计算 (Layout)</h3><p><strong>路径</strong>: <code>Source/WebCore/rendering/RenderBlockFlow.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RenderBlockFlow::layoutBlock</span><span class="params">(<span class="type">bool</span> relayoutChildren)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. 清除之前的布局数据</span></span><br><span class="line">    <span class="built_in">clearFloats</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 计算自身宽度</span></span><br><span class="line">    <span class="built_in">computeLogicalWidth</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 递归布局子元素</span></span><br><span class="line">    <span class="built_in">layoutBlockChildren</span>(relayoutChildren);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 计算自身高度</span></span><br><span class="line">    <span class="built_in">computeLogicalHeight</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 处理浮动和溢出</span></span><br><span class="line">    <span class="built_in">handleAfterFloats</span>();</span><br><span class="line">    <span class="built_in">computeOverflow</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-3"><a href="#iOS-类比-3" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 布局过程类似 UIView 的 layoutSubviews</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UIView</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">layoutSubviews</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.layoutSubviews()</span><br><span class="line">        <span class="comment">// 计算并设置子视图的 frame</span></span><br><span class="line">        <span class="keyword">for</span> subview <span class="keyword">in</span> subviews &#123;</span><br><span class="line">            subview.frame <span class="operator">=</span> calculateFrame(for: subview)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者 Auto Layout 的约束求解过程</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-RenderLayer-图层系统"><a href="#4-5-RenderLayer-图层系统" class="headerlink" title="4.5 RenderLayer - 图层系统"></a>4.5 RenderLayer - 图层系统</h3><p><strong>路径</strong>: <code>Source/WebCore/rendering/RenderLayer.h</code></p>
<p>RenderLayer 负责分层渲染，这是实现 CSS 3D 变换、透明度等效果的基础。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RenderLayer</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 是否创建合成层</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isComposited</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 变换</span></span><br><span class="line">    <span class="function">TransformationMatrix* <span class="title">transform</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 滚动</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">scrollTo</span><span class="params">(<span class="type">const</span> ScrollPosition&amp;)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 裁剪</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">updateClipRects</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绘制</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">paintLayer</span><span class="params">(PaintInfo&amp;)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="什么情况下会创建独立图层？"><a href="#什么情况下会创建独立图层？" class="headerlink" title="什么情况下会创建独立图层？"></a>什么情况下会创建独立图层？</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 这些 CSS 会导致创建新的 RenderLayer */</span></span><br><span class="line"><span class="selector-class">.layer</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate3d</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);  <span class="comment">/* 3D 变换 */</span></span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.9</span>;                      <span class="comment">/* 不完全透明 */</span></span><br><span class="line">    <span class="attribute">position</span>: fixed;                   <span class="comment">/* 固定定位 */</span></span><br><span class="line">    <span class="attribute">overflow</span>: scroll;                  <span class="comment">/* 滚动 */</span></span><br><span class="line">    <span class="attribute">will-change</span>: transform;            <span class="comment">/* 预告变化 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-4"><a href="#iOS-类比-4" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RenderLayer 非常类似 CALayer</span></span><br><span class="line"><span class="comment">// 特别是涉及到合成和硬件加速时</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// iOS 中强制创建独立图层：</span></span><br><span class="line">view.layer.shouldRasterize <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">// 或使用 3D 变换：</span></span><br><span class="line">view.layer.transform <span class="operator">=</span> <span class="type">CATransform3DMakeTranslation</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4-6-绘制-Paint"><a href="#4-6-绘制-Paint" class="headerlink" title="4.6 绘制 (Paint)"></a>4.6 绘制 (Paint)</h3><p><strong>路径</strong>: <code>Source/WebCore/rendering/PaintInfo.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PaintInfo</span> &#123;</span><br><span class="line">    GraphicsContext&amp; context;      <span class="comment">// 图形上下文</span></span><br><span class="line">    <span class="type">const</span> LayoutRect&amp; rect;        <span class="comment">// 绘制区域</span></span><br><span class="line">    PaintPhase phase;              <span class="comment">// 绘制阶段</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绘制阶段</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">PaintPhase</span> &#123;</span><br><span class="line">    BlockBackground,      <span class="comment">// 背景</span></span><br><span class="line">    ChildBlockBackgrounds,</span><br><span class="line">    Float,               <span class="comment">// 浮动元素</span></span><br><span class="line">    Foreground,          <span class="comment">// 前景（文本等）</span></span><br><span class="line">    Outline,             <span class="comment">// 轮廓</span></span><br><span class="line">    ChildOutlines,</span><br><span class="line">    Selection,           <span class="comment">// 选中状态</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-5"><a href="#iOS-类比-5" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类似于 UIView 的 draw(_:) 或 CALayer 的 draw(in:)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UIView</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">draw</span>(<span class="keyword">_</span> <span class="params">rect</span>: <span class="type">CGRect</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> context <span class="operator">=</span> <span class="type">UIGraphicsGetCurrentContext</span>()<span class="operator">!</span></span><br><span class="line">        <span class="comment">// 绘制背景</span></span><br><span class="line">        context.setFillColor(backgroundColor<span class="operator">?</span>.cgColor <span class="operator">??</span> .clear)</span><br><span class="line">        context.fill(bounds)</span><br><span class="line">        <span class="comment">// 绘制内容</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-JavaScript-引擎-JavaScriptCore"><a href="#5-JavaScript-引擎-JavaScriptCore" class="headerlink" title="5. JavaScript 引擎 (JavaScriptCore)"></a>5. JavaScript 引擎 (JavaScriptCore)</h2><h3 id="5-1-JavaScriptCore-架构"><a href="#5-1-JavaScriptCore-架构" class="headerlink" title="5.1 JavaScriptCore 架构"></a>5.1 JavaScriptCore 架构</h3><p>JavaScriptCore (JSC) 是 WebKit 的 JavaScript 引擎，也是 iOS 上可以直接使用的框架。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">JS 源代码</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────┐</span><br><span class="line">│   Parser    │  ← 词法/语法分析</span><br><span class="line">└─────────────┘</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────┐</span><br><span class="line">│  ByteCode   │  ← 生成字节码</span><br><span class="line">└─────────────┘</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────────────────────┐</span><br><span class="line">│         执行层 (分层优化)         │</span><br><span class="line">├─────────────┬─────────┬─────────┤</span><br><span class="line">│    LLInt    │   JIT   │  DFG/   │</span><br><span class="line">│  (解释器)    │ (基线)  │  FTL    │</span><br><span class="line">│  最快启动    │  平衡    │ 最优化  │</span><br><span class="line">└─────────────┴─────────┴─────────┘</span><br></pre></td></tr></table></figure>

<h3 id="5-2-执行层级详解"><a href="#5-2-执行层级详解" class="headerlink" title="5.2 执行层级详解"></a>5.2 执行层级详解</h3><h4 id="LLInt-Low-Level-Interpreter"><a href="#LLInt-Low-Level-Interpreter" class="headerlink" title="LLInt (Low Level Interpreter)"></a>LLInt (Low Level Interpreter)</h4><p><strong>路径</strong>: <code>Source/JavaScriptCore/llint/</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LLInt 是最快启动的执行方式</span></span><br><span class="line"><span class="comment">// 直接解释执行字节码，不需要编译时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 字节码示例</span></span><br><span class="line"><span class="comment">// 对于: let a = 1 + 2;</span></span><br><span class="line"><span class="built_in">OpAdd</span>(dst: a, src1: <span class="number">1</span>, src2: <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Baseline-JIT"><a href="#Baseline-JIT" class="headerlink" title="Baseline JIT"></a>Baseline JIT</h4><p><strong>路径</strong>: <code>Source/JavaScriptCore/jit/</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当函数被多次调用时，触发 Baseline JIT</span></span><br><span class="line"><span class="comment">// 生成机器码，但不做优化</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否需要 JIT</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">shouldJIT</span><span class="params">(CodeBlock* codeBlock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> codeBlock-&gt;<span class="built_in">llintExecuteCounter</span>() &gt; Options::thresholdForJIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DFG-Data-Flow-Graph-JIT"><a href="#DFG-Data-Flow-Graph-JIT" class="headerlink" title="DFG (Data Flow Graph) JIT"></a>DFG (Data Flow Graph) JIT</h4><p><strong>路径</strong>: <code>Source/JavaScriptCore/dfg/</code></p>
<p>进行类型推测和优化：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DFG 会分析变量类型，进行优化</span></span><br><span class="line"><span class="comment">// 例如：如果检测到 a 总是 int，就生成 int 专用代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型推测</span></span><br><span class="line">SpeculatedType speculatedType = profile-&gt;<span class="built_in">probableType</span>();</span><br><span class="line"><span class="keyword">if</span> (speculatedType == SpecInt32) &#123;</span><br><span class="line">    <span class="comment">// 生成 int32 优化代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FTL-Faster-Than-Light"><a href="#FTL-Faster-Than-Light" class="headerlink" title="FTL (Faster Than Light)"></a>FTL (Faster Than Light)</h4><p><strong>路径</strong>: <code>Source/JavaScriptCore/ftl/</code></p>
<p>最高级别的优化，使用 LLVM 后端（在某些平台上）。</p>
<h3 id="5-3-iOS-中使用-JavaScriptCore"><a href="#5-3-iOS-中使用-JavaScriptCore" class="headerlink" title="5.3 iOS 中使用 JavaScriptCore"></a>5.3 iOS 中使用 JavaScriptCore</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> JavaScriptCore</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 JS 上下文</span></span><br><span class="line"><span class="keyword">let</span> context <span class="operator">=</span> <span class="type">JSContext</span>()<span class="operator">!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 JS 代码</span></span><br><span class="line"><span class="keyword">let</span> result <span class="operator">=</span> context.evaluateScript(<span class="string">&quot;1 + 2&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result<span class="operator">?</span>.toInt32() <span class="operator">??</span> <span class="number">0</span>)  <span class="comment">// 输出: 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 暴露 Swift 函数给 JS</span></span><br><span class="line"><span class="keyword">let</span> logFunc: <span class="keyword">@convention(block)</span> (<span class="type">String</span>) -&gt; <span class="type">Void</span> <span class="operator">=</span> &#123; message <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;JS says: <span class="subst">\(message)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">context.setObject(logFunc, forKeyedSubscript: <span class="string">&quot;nativeLog&quot;</span> <span class="keyword">as</span> <span class="type">NSString</span>)</span><br><span class="line">context.evaluateScript(<span class="string">&quot;nativeLog(&#x27;Hello from JavaScript!&#x27;)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从 JS 获取对象</span></span><br><span class="line">context.evaluateScript(<span class="string">&quot;var person = &#123; name: &#x27;John&#x27;, age: 30 &#125;&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> person <span class="operator">=</span> context.objectForKeyedSubscript(<span class="string">&quot;person&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> name <span class="operator">=</span> person<span class="operator">?</span>.objectForKeyedSubscript(<span class="string">&quot;name&quot;</span>)<span class="operator">?</span>.toString()</span><br></pre></td></tr></table></figure>

<h3 id="5-4-JSC-内部对象模型"><a href="#5-4-JSC-内部对象模型" class="headerlink" title="5.4 JSC 内部对象模型"></a>5.4 JSC 内部对象模型</h3><p><strong>路径</strong>: <code>Source/JavaScriptCore/runtime/</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSValue - 所有 JS 值的基类</span></span><br><span class="line"><span class="comment">// Source/JavaScriptCore/runtime/JSCJSValue.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSValue</span> &#123;</span><br><span class="line">    <span class="comment">// 使用&quot;标记指针&quot;技术，高效存储不同类型</span></span><br><span class="line">    <span class="comment">// 小整数直接存在指针里，不需要堆分配</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSObject - 所有 JS 对象的基类  </span></span><br><span class="line"><span class="comment">// Source/JavaScriptCore/runtime/JSObject.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSObject</span> : <span class="keyword">public</span> JSCell &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 属性存储</span></span><br><span class="line">    <span class="function">Structure* <span class="title">structure</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 对象的&quot;形状&quot;</span></span><br><span class="line">    <span class="function">Butterfly* <span class="title">butterfly</span><span class="params">()</span></span>;        <span class="comment">// 属性存储区</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 属性操作</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">getOwnPropertySlot</span><span class="params">(PropertyName, PropertySlot&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">put</span><span class="params">(PropertyName, JSValue)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-垃圾回收-Garbage-Collection"><a href="#5-5-垃圾回收-Garbage-Collection" class="headerlink" title="5.5 垃圾回收 (Garbage Collection)"></a>5.5 垃圾回收 (Garbage Collection)</h3><p><strong>路径</strong>: <code>Source/JavaScriptCore/heap/</code></p>
<p>JSC 使用<strong>标记-清除</strong> (Mark-Sweep) 算法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source/JavaScriptCore/heap/Heap.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Heap</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 分配内存</span></span><br><span class="line">    <span class="function"><span class="type">void</span>* <span class="title">allocate</span><span class="params">(<span class="type">size_t</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 触发 GC</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">collect</span><span class="params">(CollectionScope)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// GC 阶段</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">markRoots</span><span class="params">()</span></span>;       <span class="comment">// 标记阶段：从根对象开始遍历</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sweep</span><span class="params">()</span></span>;           <span class="comment">// 清除阶段：回收未标记对象</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-6"><a href="#iOS-类比-6" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSC 的 GC 类似于 Swift 的 ARC，但机制不同：</span></span><br><span class="line"><span class="comment">// - ARC: 引用计数，立即释放</span></span><br><span class="line"><span class="comment">// - GC: 标记清除，批量释放</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 iOS 中使用 JSManagedValue 防止循环引用</span></span><br><span class="line"><span class="keyword">let</span> managedValue <span class="operator">=</span> <span class="type">JSManagedValue</span>(value: jsValue, andOwner: <span class="keyword">self</span>)</span><br><span class="line">context.virtualMachine.addManagedReference(managedValue, withOwner: <span class="keyword">self</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-多进程架构"><a href="#6-多进程架构" class="headerlink" title="6. 多进程架构"></a>6. 多进程架构</h2><h3 id="6-1-进程模型概述"><a href="#6-1-进程模型概述" class="headerlink" title="6.1 进程模型概述"></a>6.1 进程模型概述</h3><p>现代 WebKit (WebKit2) 使用多进程架构，这是 iOS 上 WKWebView 比 UIWebView 更安全、更稳定的原因。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────┐</span><br><span class="line">│                    你的 iOS App                      │</span><br><span class="line">│  ┌───────────────────────────────────────────────┐  │</span><br><span class="line">│  │              UI Process (UIProcess)            │  │</span><br><span class="line">│  │  • WKWebView                                   │  │</span><br><span class="line">│  │  • WebPageProxy                                │  │</span><br><span class="line">│  │  • 处理用户输入                                  │  │</span><br><span class="line">│  └───────────────────────────────────────────────┘  │</span><br><span class="line">└─────────────────────────────────────────────────────┘</span><br><span class="line">                          │ IPC</span><br><span class="line">                          ▼</span><br><span class="line">┌─────────────────────────────────────────────────────┐</span><br><span class="line">│              Web Content Process (WebProcess)        │</span><br><span class="line">│  ┌───────────────────────────────────────────────┐  │</span><br><span class="line">│  │  • WebPage                                     │  │</span><br><span class="line">│  │  • DOM/渲染/JavaScript                          │  │</span><br><span class="line">│  │  • 沙盒隔离，无法访问文件系统                     │  │</span><br><span class="line">│  └───────────────────────────────────────────────┘  │</span><br><span class="line">└─────────────────────────────────────────────────────┘</span><br><span class="line">                          │ IPC</span><br><span class="line">                          ▼</span><br><span class="line">┌─────────────────────────────────────────────────────┐</span><br><span class="line">│              Network Process                         │</span><br><span class="line">│  • 处理所有网络请求                                   │</span><br><span class="line">│  • Cookie 管理                                       │</span><br><span class="line">│  • 缓存管理                                          │</span><br><span class="line">└─────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="6-2-UIProcess-UI-进程"><a href="#6-2-UIProcess-UI-进程" class="headerlink" title="6.2 UIProcess - UI 进程"></a>6.2 UIProcess - UI 进程</h3><p><strong>路径</strong>: <code>Source/WebKit/UIProcess/</code></p>
<p>这是你的 App 进程，包含 WKWebView 的公开 API。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">UIProcess/</span><br><span class="line">├── API/</span><br><span class="line">│   └── Cocoa/</span><br><span class="line">│       ├── WKWebView.h          # WKWebView 接口</span><br><span class="line">│       ├── WKWebView.mm         # WKWebView 实现</span><br><span class="line">│       ├── WKNavigationDelegate.h</span><br><span class="line">│       └── WKUIDelegate.h</span><br><span class="line">├── WebPageProxy.cpp             # 代理 WebProcess 中的 WebPage</span><br><span class="line">├── WebProcessProxy.cpp          # 管理 WebProcess</span><br><span class="line">└── ios/</span><br><span class="line">    └── WKContentView.mm         # iOS 特有的内容视图</span><br></pre></td></tr></table></figure>

<h3 id="6-3-WebProcess-Web-内容进程"><a href="#6-3-WebProcess-Web-内容进程" class="headerlink" title="6.3 WebProcess - Web 内容进程"></a>6.3 WebProcess - Web 内容进程</h3><p><strong>路径</strong>: <code>Source/WebKit/WebProcess/</code></p>
<p>实际执行网页渲染和 JavaScript 的进程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WebProcess/</span><br><span class="line">├── WebPage/</span><br><span class="line">│   ├── WebPage.cpp              # 代表一个网页</span><br><span class="line">│   └── WebFrame.cpp             # 代表一个 frame</span><br><span class="line">├── WebCoreSupport/</span><br><span class="line">│   └── WebChromeClient.cpp      # WebCore 的回调接口</span><br><span class="line">└── WebProcess.cpp               # 进程主类</span><br></pre></td></tr></table></figure>

<h3 id="6-4-进程间通信-IPC"><a href="#6-4-进程间通信-IPC" class="headerlink" title="6.4 进程间通信 (IPC)"></a>6.4 进程间通信 (IPC)</h3><p><strong>路径</strong>: <code>Source/WebKit/Platform/IPC/</code></p>
<p>WebKit 使用自定义的 IPC 系统进行进程间通信。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消息定义示例</span></span><br><span class="line"><span class="comment">// Source/WebKit/UIProcess/WebPageProxy.messages.in</span></span><br><span class="line"></span><br><span class="line">messages -&gt; WebPageProxy &#123;</span><br><span class="line">    <span class="comment">// 页面加载完成</span></span><br><span class="line">    <span class="built_in">DidFinishLoadForFrame</span>(WebKit::FrameInfoData frameInfo)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 标题改变</span></span><br><span class="line">    <span class="built_in">TitleChanged</span>(String title)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 需要显示 alert</span></span><br><span class="line">    <span class="built_in">RunJavaScriptAlert</span>(String message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-7"><a href="#iOS-类比-7" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IPC 类似于 iOS 中的 XPC 或 Distributed Notifications</span></span><br><span class="line"><span class="comment">// 但 WebKit 有自己的高效实现</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 跨进程调用类似于：</span></span><br><span class="line"><span class="keyword">let</span> connection <span class="operator">=</span> <span class="type">NSXPCConnection</span>(serviceName: <span class="string">&quot;com.apple.WebProcess&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> proxy <span class="operator">=</span> connection.remoteObjectProxy <span class="keyword">as?</span> <span class="type">WebPageProtocol</span></span><br><span class="line">proxy<span class="operator">?</span>.loadURL(url)</span><br></pre></td></tr></table></figure>

<h3 id="6-5-多进程的好处"><a href="#6-5-多进程的好处" class="headerlink" title="6.5 多进程的好处"></a>6.5 多进程的好处</h3><table>
<thead>
<tr>
<th>优势</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>安全性</strong></td>
<td>Web 内容在沙盒中运行，无法直接访问 App 数据</td>
</tr>
<tr>
<td><strong>稳定性</strong></td>
<td>Web 进程崩溃不会影响主 App</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>多进程可以利用多核 CPU</td>
</tr>
<tr>
<td><strong>内存管理</strong></td>
<td>可以单独终止占用内存过大的 Web 进程</td>
</tr>
</tbody></table>
<p>这就是为什么 WKWebView 比 UIWebView 更推荐使用的原因！</p>
<hr>
<h2 id="7-WKWebView-与-iOS-开发"><a href="#7-WKWebView-与-iOS-开发" class="headerlink" title="7. WKWebView 与 iOS 开发"></a>7. WKWebView 与 iOS 开发</h2><h3 id="7-1-WKWebView-类结构"><a href="#7-1-WKWebView-类结构" class="headerlink" title="7.1 WKWebView 类结构"></a>7.1 WKWebView 类结构</h3><p><strong>路径</strong>: <code>Source/WebKit/UIProcess/API/Cocoa/WKWebView.h</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WKWebView</span> : <span class="title">UIView</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">WKWebViewConfiguration</span> *configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代理</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;<span class="built_in">WKNavigationDelegate</span>&gt; navigationDelegate;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;<span class="built_in">WKUIDelegate</span>&gt; <span class="built_in">UIDelegate</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导航</span></span><br><span class="line">- (<span class="built_in">WKNavigation</span> *)loadRequest:(<span class="built_in">NSURLRequest</span> *)request;</span><br><span class="line">- (<span class="built_in">WKNavigation</span> *)loadHTMLString:(<span class="built_in">NSString</span> *)string baseURL:(<span class="built_in">NSURL</span> *)baseURL;</span><br><span class="line">- (<span class="built_in">WKNavigation</span> *)goBack;</span><br><span class="line">- (<span class="built_in">WKNavigation</span> *)goForward;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSURL</span> *URL;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSString</span> *title;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="type">double</span> estimatedProgress;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">getter</span>=isLoading) <span class="type">BOOL</span> loading;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JavaScript</span></span><br><span class="line">- (<span class="type">void</span>)evaluateJavaScript:(<span class="built_in">NSString</span> *)javaScript </span><br><span class="line">         completionHandler:(<span class="type">void</span> (^)(<span class="type">id</span>, <span class="built_in">NSError</span> *))completionHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 截图</span></span><br><span class="line">- (<span class="type">void</span>)takeSnapshotWithConfiguration:(<span class="built_in">WKSnapshotConfiguration</span> *)config</span><br><span class="line">                    completionHandler:(<span class="type">void</span> (^)(<span class="built_in">UIImage</span> *, <span class="built_in">NSError</span> *))completionHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-WKWebView-内部实现"><a href="#7-2-WKWebView-内部实现" class="headerlink" title="7.2 WKWebView 内部实现"></a>7.2 WKWebView 内部实现</h3><p><strong>路径</strong>: <code>Source/WebKit/UIProcess/API/Cocoa/WKWebView.mm</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WKWebView</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 核心：WebPageProxy 是与 WebProcess 通信的桥梁</span></span><br><span class="line">    std::unique_ptr&lt;WebKit::WebPageProxy&gt; _page;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// iOS 特有：内容视图</span></span><br><span class="line">    RetainPtr&lt;<span class="built_in">WKContentView</span>&gt; _contentView;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 滚动视图</span></span><br><span class="line">    RetainPtr&lt;<span class="built_in">WKScrollView</span>&gt; _scrollView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame configuration:(<span class="built_in">WKWebViewConfiguration</span> *)configuration</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 创建 UIView</span></span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">self</span> = [<span class="variable language_">super</span> initWithFrame:frame]))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 初始化 WebPageProxy（连接到 WebProcess）</span></span><br><span class="line">    _page = WebPageProxy::create(<span class="comment">/* ... */</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 创建内容视图</span></span><br><span class="line">    _contentView = adoptNS([[<span class="built_in">WKContentView</span> alloc] initWithFrame:bounds]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 创建滚动视图</span></span><br><span class="line">    _scrollView = adoptNS([[<span class="built_in">WKScrollView</span> alloc] initWithFrame:bounds]);</span><br><span class="line">    [_scrollView addSubview:_contentView.get()];</span><br><span class="line">    [<span class="keyword">self</span> addSubview:_scrollView.get()];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">WKNavigation</span> *)loadRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 通过 IPC 发送给 WebProcess</span></span><br><span class="line">    <span class="keyword">return</span> _page-&gt;loadRequest(request);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-WKContentView-iOS-内容视图"><a href="#7-3-WKContentView-iOS-内容视图" class="headerlink" title="7.3 WKContentView - iOS 内容视图"></a>7.3 WKContentView - iOS 内容视图</h3><p><strong>路径</strong>: <code>Source/WebKit/UIProcess/ios/WKContentView.mm</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WKContentView</span> : <span class="title">UIView</span> &lt;<span class="title">UIGestureRecognizerDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理触摸事件</span></span><br><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event;</span><br><span class="line">- (<span class="type">void</span>)touchesMoved:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event;</span><br><span class="line">- (<span class="type">void</span>)touchesEnded:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 手势识别器</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UITapGestureRecognizer</span> *singleTapGestureRecognizer;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UILongPressGestureRecognizer</span> *longPressGestureRecognizer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输入处理</span></span><br><span class="line">- (<span class="type">void</span>)_setUpTextSelectionAssistant;</span><br><span class="line">- (<span class="type">void</span>)_showKeyboard;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-4-与原生交互"><a href="#7-4-与原生交互" class="headerlink" title="7.4 与原生交互"></a>7.4 与原生交互</h3><h4 id="Swift-调用-JavaScript"><a href="#Swift-调用-JavaScript" class="headerlink" title="Swift 调用 JavaScript"></a>Swift 调用 JavaScript</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行 JS 代码</span></span><br><span class="line">webView.evaluateJavaScript(<span class="string">&quot;document.title&quot;</span>) &#123; result, error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> title <span class="operator">=</span> result <span class="keyword">as?</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;页面标题: <span class="subst">\(title)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注入 JS 脚本</span></span><br><span class="line"><span class="keyword">let</span> script <span class="operator">=</span> <span class="type">WKUserScript</span>(</span><br><span class="line">    source: <span class="string">&quot;console.log(&#x27;Hello from Swift!&#x27;)&quot;</span>,</span><br><span class="line">    injectionTime: .atDocumentStart,</span><br><span class="line">    forMainFrameOnly: <span class="literal">true</span></span><br><span class="line">)</span><br><span class="line">webView.configuration.userContentController.addUserScript(script)</span><br></pre></td></tr></table></figure>

<h4 id="JavaScript-调用-Swift"><a href="#JavaScript-调用-Swift" class="headerlink" title="JavaScript 调用 Swift"></a>JavaScript 调用 Swift</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 添加消息处理器</span></span><br><span class="line">webView.configuration.userContentController.add(<span class="keyword">self</span>, name: <span class="string">&quot;nativeHandler&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 实现协议</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">ViewController</span>: <span class="title class_ inherited__">WKScriptMessageHandler</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">userContentController</span>(<span class="keyword">_</span> <span class="params">controller</span>: <span class="type">WKUserContentController</span>,</span><br><span class="line">                               <span class="params">didReceive</span> <span class="params">message</span>: <span class="type">WKScriptMessage</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> message.name <span class="operator">==</span> <span class="string">&quot;nativeHandler&quot;</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;收到消息: <span class="subst">\(message.body)</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. JS 端调用</span></span><br><span class="line"><span class="comment">// window.webkit.messageHandlers.nativeHandler.postMessage(&#x27;Hello from JS!&#x27;)</span></span><br></pre></td></tr></table></figure>

<h3 id="7-5-WKWebView-生命周期"><a href="#7-5-WKWebView-生命周期" class="headerlink" title="7.5 WKWebView 生命周期"></a>7.5 WKWebView 生命周期</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WebViewController</span>: <span class="title class_ inherited__">UIViewController</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> webView: <span class="type">WKWebView</span>!</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 配置</span></span><br><span class="line">        <span class="keyword">let</span> config <span class="operator">=</span> <span class="type">WKWebViewConfiguration</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建（此时会启动 WebProcess）</span></span><br><span class="line">        webView <span class="operator">=</span> <span class="type">WKWebView</span>(frame: view.bounds, configuration: config)</span><br><span class="line">        webView.navigationDelegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">        view.addSubview(webView)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 加载</span></span><br><span class="line">        <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://apple.com&quot;</span>)<span class="operator">!</span></span><br><span class="line">        webView.load(<span class="type">URLRequest</span>(url: url))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="comment">// WKWebView 释放时，会清理 WebProcess 资源</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">WebViewController</span>: <span class="title class_ inherited__">WKNavigationDelegate</span> &#123;</span><br><span class="line">    <span class="comment">// 开始导航</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">webView</span>(<span class="keyword">_</span> <span class="params">webView</span>: <span class="type">WKWebView</span>,</span><br><span class="line">                 <span class="params">didStartProvisionalNavigation</span> <span class="params">navigation</span>: <span class="type">WKNavigation</span>!) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始加载&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 收到响应</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">webView</span>(<span class="keyword">_</span> <span class="params">webView</span>: <span class="type">WKWebView</span>,</span><br><span class="line">                 <span class="params">didReceiveServerRedirectForProvisionalNavigation</span> <span class="params">navigation</span>: <span class="type">WKNavigation</span>!) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;重定向&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内容开始到达</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">webView</span>(<span class="keyword">_</span> <span class="params">webView</span>: <span class="type">WKWebView</span>,</span><br><span class="line">                 <span class="params">didCommit</span> <span class="params">navigation</span>: <span class="type">WKNavigation</span>!) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始渲染&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载完成</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">webView</span>(<span class="keyword">_</span> <span class="params">webView</span>: <span class="type">WKWebView</span>,</span><br><span class="line">                 <span class="params">didFinish</span> <span class="params">navigation</span>: <span class="type">WKNavigation</span>!) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;加载完成&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载失败</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">webView</span>(<span class="keyword">_</span> <span class="params">webView</span>: <span class="type">WKWebView</span>,</span><br><span class="line">                 <span class="params">didFail</span> <span class="params">navigation</span>: <span class="type">WKNavigation</span>!,</span><br><span class="line">                 <span class="params">withError</span> <span class="params">error</span>: <span class="type">Error</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;加载失败: <span class="subst">\(error)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-网络与资源加载"><a href="#8-网络与资源加载" class="headerlink" title="8. 网络与资源加载"></a>8. 网络与资源加载</h2><h3 id="8-1-资源加载架构"><a href="#8-1-资源加载架构" class="headerlink" title="8.1 资源加载架构"></a>8.1 资源加载架构</h3><p><strong>路径</strong>: <code>Source/WebCore/loader/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">网页请求</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│  DocumentLoader │  ← 文档加载器（主文档）</span><br><span class="line">└─────────────────┘</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│  FrameLoader    │  ← Frame 加载器</span><br><span class="line">└─────────────────┘</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ ResourceLoader  │  ← 资源加载器</span><br><span class="line">└─────────────────┘</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   网络层         │  ← 实际网络请求</span><br><span class="line">└─────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="8-2-FrameLoader-帧加载器"><a href="#8-2-FrameLoader-帧加载器" class="headerlink" title="8.2 FrameLoader - 帧加载器"></a>8.2 FrameLoader - 帧加载器</h3><p><strong>路径</strong>: <code>Source/WebCore/loader/FrameLoader.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FrameLoader</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 加载请求</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">load</span><span class="params">(FrameLoadRequest&amp;&amp;)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载 HTML 字符串</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">loadHTMLString</span><span class="params">(<span class="type">const</span> String&amp; html, <span class="type">const</span> URL&amp; baseURL)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 导航控制</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reload</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">stopAllLoaders</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 状态</span></span><br><span class="line">    <span class="function">FrameLoadType <span class="title">loadType</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isLoading</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 历史管理</span></span><br><span class="line">    <span class="function">HistoryController&amp; <span class="title">history</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-ResourceLoader-资源加载器"><a href="#8-3-ResourceLoader-资源加载器" class="headerlink" title="8.3 ResourceLoader - 资源加载器"></a>8.3 ResourceLoader - 资源加载器</h3><p><strong>路径</strong>: <code>Source/WebCore/loader/ResourceLoader.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceLoader</span> : <span class="keyword">public</span> ResourceHandleClient &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 资源类型</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Type</span> &#123;</span><br><span class="line">        MainResource,      <span class="comment">// 主文档</span></span><br><span class="line">        Image,            <span class="comment">// 图片</span></span><br><span class="line">        CSSStyleSheet,    <span class="comment">// 样式表</span></span><br><span class="line">        Script,           <span class="comment">// 脚本</span></span><br><span class="line">        Font,             <span class="comment">// 字体</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载回调</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">didReceiveResponse</span><span class="params">(<span class="type">const</span> ResourceResponse&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">didReceiveData</span><span class="params">(<span class="type">const</span> SharedBuffer&amp;, <span class="type">long</span> <span class="type">long</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">didFinishLoading</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">didFail</span><span class="params">(<span class="type">const</span> ResourceError&amp;)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="8-4-缓存机制"><a href="#8-4-缓存机制" class="headerlink" title="8.4 缓存机制"></a>8.4 缓存机制</h3><p><strong>路径</strong>: <code>Source/WebCore/loader/cache/</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CachedResource - 缓存的资源</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CachedResource</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Status</span> &#123;</span><br><span class="line">        Unknown,      <span class="comment">// 未知</span></span><br><span class="line">        Pending,      <span class="comment">// 加载中</span></span><br><span class="line">        Cached,       <span class="comment">// 已缓存</span></span><br><span class="line">        LoadError,    <span class="comment">// 加载错误</span></span><br><span class="line">        DecodeError   <span class="comment">// 解码错误</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 数据</span></span><br><span class="line">    <span class="function">SharedBuffer* <span class="title">data</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">mustRevalidateDueToCacheHeaders</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MemoryCache - 内存缓存</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryCache</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">CachedResource* <span class="title">resourceForRequest</span><span class="params">(<span class="type">const</span> ResourceRequest&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(CachedResource&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(CachedResource&amp;)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-8"><a href="#iOS-类比-8" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类似 URLCache</span></span><br><span class="line"><span class="keyword">let</span> cache <span class="operator">=</span> <span class="type">URLCache</span>.shared</span><br><span class="line"><span class="keyword">let</span> cachedResponse <span class="operator">=</span> cache.cachedResponse(for: request)</span><br></pre></td></tr></table></figure>

<h3 id="8-5-网络进程通信"><a href="#8-5-网络进程通信" class="headerlink" title="8.5 网络进程通信"></a>8.5 网络进程通信</h3><p>在多进程架构中，实际的网络请求在 NetworkProcess 中执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WKWebView (UIProcess)</span><br><span class="line">       ↓</span><br><span class="line">    IPC 消息</span><br><span class="line">       ↓</span><br><span class="line">WebProcess (请求发起)</span><br><span class="line">       ↓</span><br><span class="line">    IPC 消息  </span><br><span class="line">       ↓</span><br><span class="line">NetworkProcess (实际网络请求)</span><br><span class="line">       ↓</span><br><span class="line">    URLSession</span><br><span class="line">       ↓</span><br><span class="line">    网络</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-事件处理系统"><a href="#9-事件处理系统" class="headerlink" title="9. 事件处理系统"></a>9. 事件处理系统</h2><h3 id="9-1-事件流概述"><a href="#9-1-事件流概述" class="headerlink" title="9.1 事件流概述"></a>9.1 事件流概述</h3><p>DOM 事件遵循 W3C 标准的三个阶段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Document          1. 捕获阶段 (Capture)</span><br><span class="line">    ↓</span><br><span class="line">  &lt;html&gt;          事件从 Document 向下传播</span><br><span class="line">    ↓</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    ↓</span><br><span class="line">   &lt;div&gt;          2. 目标阶段 (Target)</span><br><span class="line">    ↓             事件到达目标元素</span><br><span class="line">  &lt;button&gt;  ← 点击目标</span><br><span class="line">    ↑</span><br><span class="line">   &lt;div&gt;          3. 冒泡阶段 (Bubble)</span><br><span class="line">    ↑</span><br><span class="line">  &lt;body&gt;          事件从目标向上传播</span><br><span class="line">    ↑</span><br><span class="line">  &lt;html&gt;</span><br><span class="line">    ↑</span><br><span class="line">Document</span><br></pre></td></tr></table></figure>

<h3 id="9-2-EventDispatcher-事件分发器"><a href="#9-2-EventDispatcher-事件分发器" class="headerlink" title="9.2 EventDispatcher - 事件分发器"></a>9.2 EventDispatcher - 事件分发器</h3><p><strong>路径</strong>: <code>Source/WebCore/dom/EventDispatcher.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventDispatcher::dispatchEvent</span><span class="params">(Node&amp; node, Event&amp; event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. 构建事件路径</span></span><br><span class="line">    <span class="function">EventPath <span class="title">eventPath</span><span class="params">(node, event)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 捕获阶段</span></span><br><span class="line">    event.<span class="built_in">setEventPhase</span>(Event::CAPTURING_PHASE);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = eventPath.<span class="built_in">size</span>(); i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">        eventPath.<span class="built_in">contextAt</span>(i - <span class="number">1</span>).<span class="built_in">handleLocalEvents</span>(event, Capturing);</span><br><span class="line">        <span class="keyword">if</span> (event.<span class="built_in">propagationStopped</span>())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 目标阶段</span></span><br><span class="line">    event.<span class="built_in">setEventPhase</span>(Event::AT_TARGET);</span><br><span class="line">    eventPath.<span class="built_in">contextAt</span>(<span class="number">0</span>).<span class="built_in">handleLocalEvents</span>(event, Bubbling);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 冒泡阶段</span></span><br><span class="line">    <span class="keyword">if</span> (event.<span class="built_in">bubbles</span>()) &#123;</span><br><span class="line">        event.<span class="built_in">setEventPhase</span>(Event::BUBBLING_PHASE);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">1</span>; i &lt; eventPath.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">            eventPath.<span class="built_in">contextAt</span>(i).<span class="built_in">handleLocalEvents</span>(event, Bubbling);</span><br><span class="line">            <span class="keyword">if</span> (event.<span class="built_in">propagationStopped</span>())</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 默认处理</span></span><br><span class="line">    <span class="built_in">callDefaultEventHandlers</span>(event, eventPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-Event-事件基类"><a href="#9-3-Event-事件基类" class="headerlink" title="9.3 Event - 事件基类"></a>9.3 Event - 事件基类</h3><p><strong>路径</strong>: <code>Source/WebCore/dom/Event.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Event</span> : <span class="keyword">public</span> RefCounted&lt;Event&gt;, <span class="keyword">public</span> EventTarget &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 事件类型</span></span><br><span class="line">    <span class="function"><span class="type">const</span> AtomString&amp; <span class="title">type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 目标</span></span><br><span class="line">    <span class="function">EventTarget* <span class="title">target</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">EventTarget* <span class="title">currentTarget</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 传播控制</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">stopPropagation</span><span class="params">()</span></span>;      <span class="comment">// 停止传播</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">stopImmediatePropagation</span><span class="params">()</span></span>;  <span class="comment">// 立即停止</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">preventDefault</span><span class="params">()</span></span>;       <span class="comment">// 阻止默认行为</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 阶段</span></span><br><span class="line">    <span class="function"><span class="type">unsigned</span> <span class="type">short</span> <span class="title">eventPhase</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 冒泡</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">bubbles</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">cancelable</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="iOS-类比-9"><a href="#iOS-类比-9" class="headerlink" title="iOS 类比"></a>iOS 类比</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DOM 事件系统类似于 UIKit 的 Responder Chain</span></span><br><span class="line"><span class="comment">// 但方向相反：</span></span><br><span class="line"><span class="comment">// - DOM: 先捕获（向下）再冒泡（向上）</span></span><br><span class="line"><span class="comment">// - UIKit: 事件向上传递（通过 responder chain）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UIResponder</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">touchesBegan</span>(<span class="keyword">_</span> <span class="params">touches</span>: <span class="type">Set</span>&lt;<span class="type">UITouch</span>&gt;, <span class="params">with</span> <span class="params">event</span>: <span class="type">UIEvent</span>?)</span><br><span class="line">    <span class="keyword">var</span> next: <span class="type">UIResponder</span>? &#123; <span class="keyword">get</span> &#125;  <span class="comment">// 响应链下一个</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-4-触摸事件处理-iOS"><a href="#9-4-触摸事件处理-iOS" class="headerlink" title="9.4 触摸事件处理 (iOS)"></a>9.4 触摸事件处理 (iOS)</h3><p><strong>路径</strong>: <code>Source/WebKit/UIProcess/ios/WKContentView.mm</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 创建 WebTouchEvent</span></span><br><span class="line">    WebTouchEvent webEvent = [<span class="keyword">self</span> _touchEventForTouches:touches];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 通过 IPC 发送给 WebProcess</span></span><br><span class="line">    _page-&gt;handleTouchEvent(webEvent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WebProcess 中的处理</span></span><br><span class="line"><span class="comment">// Source/WebKit/WebProcess/WebPage/WebPage.cpp</span></span><br><span class="line"><span class="type">void</span> WebPage::handleTouchEvent(<span class="keyword">const</span> WebTouchEvent&amp; event)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 命中测试，找到触摸点下的元素</span></span><br><span class="line">    HitTestResult result = hitTest(event.position());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 创建 DOM TouchEvent</span></span><br><span class="line">    Ref&lt;TouchEvent&gt; touchEvent = TouchEvent::create(<span class="comment">/* ... */</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 分发事件</span></span><br><span class="line">    result.targetNode()-&gt;dispatchEvent(touchEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-5-事件监听器"><a href="#9-5-事件监听器" class="headerlink" title="9.5 事件监听器"></a>9.5 事件监听器</h3><p><strong>路径</strong>: <code>Source/WebCore/dom/EventTarget.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventTarget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 添加监听器</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">addEventListener</span><span class="params">(<span class="type">const</span> AtomString&amp; type,</span></span></span><br><span class="line"><span class="params"><span class="function">                         RefPtr&lt;EventListener&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">                         AddEventListenerOptions)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 移除监听器</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">removeEventListener</span><span class="params">(<span class="type">const</span> AtomString&amp; type,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EventListener&amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ListenerOptions)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分发事件</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">dispatchEvent</span><span class="params">(Event&amp;)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-CSS-样式系统"><a href="#10-CSS-样式系统" class="headerlink" title="10. CSS 样式系统"></a>10. CSS 样式系统</h2><h3 id="10-1-样式系统架构"><a href="#10-1-样式系统架构" class="headerlink" title="10.1 样式系统架构"></a>10.1 样式系统架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CSS 源文本</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   CSS Parser    │  ← 解析 CSS</span><br><span class="line">└─────────────────┘</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│  StyleSheet     │  ← 样式表对象</span><br><span class="line">└─────────────────┘</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│  StyleResolver  │  ← 样式解析器</span><br><span class="line">└─────────────────┘</span><br><span class="line">    ↓</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│  RenderStyle    │  ← 计算后的样式</span><br><span class="line">└─────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="10-2-StyleResolver-样式解析器"><a href="#10-2-StyleResolver-样式解析器" class="headerlink" title="10.2 StyleResolver - 样式解析器"></a>10.2 StyleResolver - 样式解析器</h3><p><strong>路径</strong>: <code>Source/WebCore/style/StyleResolver.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StyleResolver</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 为元素解析样式</span></span><br><span class="line">    <span class="function">RenderStyle* <span class="title">styleForElement</span><span class="params">(Element&amp;, <span class="type">const</span> RenderStyle* parentStyle)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 样式匹配</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">matchAllRules</span><span class="params">(ElementRuleCollector&amp;, <span class="type">bool</span> includeSMILProperties)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 样式继承</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">applyInheritedOnlyStyleFromParent</span><span class="params">(RenderStyle&amp;, <span class="type">const</span> RenderStyle* parentStyle)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="10-3-样式优先级（级联）"><a href="#10-3-样式优先级（级联）" class="headerlink" title="10.3 样式优先级（级联）"></a>10.3 样式优先级（级联）</h3><p>CSS 样式的优先级由高到低：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. !important 声明</span><br><span class="line">2. 行内样式 (style 属性)</span><br><span class="line">3. ID 选择器 (#id)</span><br><span class="line">4. 类选择器/属性选择器/伪类 (.class, [attr], :hover)</span><br><span class="line">5. 元素选择器/伪元素 (div, ::before)</span><br><span class="line">6. 通用选择器 (*)</span><br><span class="line">7. 继承的样式</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source/WebCore/css/SelectorChecker.cpp</span></span><br><span class="line"><span class="comment">// 计算选择器特异性</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="title">Selector::specificity</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> idCount = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> classCount = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> elementCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> Selector* selector = <span class="keyword">this</span>; selector; selector = selector-&gt;<span class="built_in">next</span>()) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (selector-&gt;<span class="built_in">match</span>()) &#123;</span><br><span class="line">        <span class="keyword">case</span> ID:</span><br><span class="line">            idCount++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Class:</span><br><span class="line">        <span class="keyword">case</span> Attribute:</span><br><span class="line">        <span class="keyword">case</span> PseudoClass:</span><br><span class="line">            classCount++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Tag:</span><br><span class="line">        <span class="keyword">case</span> PseudoElement:</span><br><span class="line">            elementCount++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回特异性值：ID * 100 + Class * 10 + Element</span></span><br><span class="line">    <span class="keyword">return</span> idCount * <span class="number">100</span> + classCount * <span class="number">10</span> + elementCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-4-RenderStyle-计算后的样式"><a href="#10-4-RenderStyle-计算后的样式" class="headerlink" title="10.4 RenderStyle - 计算后的样式"></a>10.4 RenderStyle - 计算后的样式</h3><p><strong>路径</strong>: <code>Source/WebCore/rendering/style/RenderStyle.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RenderStyle</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 盒模型</span></span><br><span class="line">    <span class="function">Length <span class="title">width</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Length <span class="title">height</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Length <span class="title">marginTop</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Length <span class="title">paddingLeft</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 定位</span></span><br><span class="line">    <span class="function">PositionType <span class="title">position</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// static, relative, absolute, fixed</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 显示</span></span><br><span class="line">    <span class="function">DisplayType <span class="title">display</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// block, inline, flex, grid</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 背景</span></span><br><span class="line">    <span class="function">Color <span class="title">backgroundColor</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 文本</span></span><br><span class="line">    <span class="function">TextAlign <span class="title">textAlign</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Color <span class="title">color</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> Font&amp; <span class="title">font</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 变换</span></span><br><span class="line">    <span class="function">TransformOperations&amp; <span class="title">transform</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 动画</span></span><br><span class="line">    <span class="function"><span class="type">const</span> AnimationList* <span class="title">transitions</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> AnimationList* <span class="title">animations</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="10-5-样式计算流程"><a href="#10-5-样式计算流程" class="headerlink" title="10.5 样式计算流程"></a>10.5 样式计算流程</h3><p>当需要计算一个元素的样式时：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source/WebCore/style/StyleTreeResolver.cpp</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StyleTreeResolver::resolveElement</span><span class="params">(Element&amp; element)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. 获取父元素样式（用于继承）</span></span><br><span class="line">    <span class="type">const</span> RenderStyle* parentStyle = element.<span class="built_in">parentElement</span>()</span><br><span class="line">        ? element.<span class="built_in">parentElement</span>()-&gt;<span class="built_in">renderStyle</span>()</span><br><span class="line">        : <span class="literal">nullptr</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 收集所有匹配的 CSS 规则</span></span><br><span class="line">    <span class="function">ElementRuleCollector <span class="title">collector</span><span class="params">(element)</span></span>;</span><br><span class="line">    collector.<span class="built_in">matchAllRules</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 按优先级排序规则</span></span><br><span class="line">    collector.<span class="built_in">sortMatchedRules</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 应用规则，生成 RenderStyle</span></span><br><span class="line">    RenderStyle* style = styleResolver.<span class="built_in">styleForElement</span>(</span><br><span class="line">        element, parentStyle);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 设置到元素上</span></span><br><span class="line">    element.<span class="built_in">setRenderStyle</span>(style);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="附录-A：调试技巧"><a href="#附录-A：调试技巧" class="headerlink" title="附录 A：调试技巧"></a>附录 A：调试技巧</h2><h3 id="在-iOS-开发中调试-WebView"><a href="#在-iOS-开发中调试-WebView" class="headerlink" title="在 iOS 开发中调试 WebView"></a>在 iOS 开发中调试 WebView</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 启用调试</span></span><br><span class="line"><span class="keyword">#if</span> <span class="type">DEBUG</span></span><br><span class="line">webView.isInspectable <span class="operator">=</span> <span class="literal">true</span>  <span class="comment">// iOS 16.4+</span></span><br><span class="line"><span class="keyword">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 在 Safari 中调试</span></span><br><span class="line"><span class="comment">// Safari -&gt; 开发 -&gt; 你的设备 -&gt; 你的页面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 监控加载进度</span></span><br><span class="line">webView.publisher(for: \.estimatedProgress)</span><br><span class="line">    .sink &#123; progress <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;加载进度: <span class="subst">\(progress <span class="operator">*</span> <span class="number">100</span>)</span>%&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .store(in: <span class="operator">&amp;</span>cancellables)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 监控 URL 变化</span></span><br><span class="line">webView.publisher(for: \.url)</span><br><span class="line">    .sink &#123; url <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;当前 URL: <span class="subst">\(url<span class="operator">?</span>.absoluteString <span class="operator">??</span> <span class="string">&quot;nil&quot;</span>)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .store(in: <span class="operator">&amp;</span>cancellables)</span><br></pre></td></tr></table></figure>

<h3 id="常见问题排查"><a href="#常见问题排查" class="headerlink" title="常见问题排查"></a>常见问题排查</h3><table>
<thead>
<tr>
<th>问题</th>
<th>可能原因</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>白屏</td>
<td>进程崩溃</td>
<td>检查内存使用，实现 <code>webViewWebContentProcessDidTerminate</code></td>
</tr>
<tr>
<td>加载慢</td>
<td>网络问题或资源过多</td>
<td>使用 Safari 开发者工具分析</td>
</tr>
<tr>
<td>JS 不执行</td>
<td>安全策略</td>
<td>检查 CSP 头，使用 <code>WKUserScript</code></td>
</tr>
<tr>
<td>内存暴涨</td>
<td>循环引用或缓存过大</td>
<td>检查 JS&#x2F;Native 交互中的引用</td>
</tr>
</tbody></table>
<hr>
<h2 id="附录-B：关键文件速查"><a href="#附录-B：关键文件速查" class="headerlink" title="附录 B：关键文件速查"></a>附录 B：关键文件速查</h2><table>
<thead>
<tr>
<th>功能</th>
<th>路径</th>
</tr>
</thead>
<tbody><tr>
<td>DOM Node</td>
<td><code>Source/WebCore/dom/Node.h</code></td>
</tr>
<tr>
<td>Document</td>
<td><code>Source/WebCore/dom/Document.h</code></td>
</tr>
<tr>
<td>渲染对象</td>
<td><code>Source/WebCore/rendering/RenderObject.h</code></td>
</tr>
<tr>
<td>布局</td>
<td><code>Source/WebCore/rendering/RenderBlockFlow.cpp</code></td>
</tr>
<tr>
<td>样式</td>
<td><code>Source/WebCore/style/StyleResolver.h</code></td>
</tr>
<tr>
<td>JS 引擎</td>
<td><code>Source/JavaScriptCore/runtime/</code></td>
</tr>
<tr>
<td>WKWebView</td>
<td><code>Source/WebKit/UIProcess/API/Cocoa/WKWebView.mm</code></td>
</tr>
<tr>
<td>事件分发</td>
<td><code>Source/WebCore/dom/EventDispatcher.cpp</code></td>
</tr>
<tr>
<td>网络加载</td>
<td><code>Source/WebCore/loader/FrameLoader.h</code></td>
</tr>
<tr>
<td>IPC</td>
<td><code>Source/WebKit/Platform/IPC/</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>作为 iOS 开发工程师，理解 WebKit 可以帮助你：</p>
<ol>
<li><strong>优化 WKWebView 性能</strong> - 知道哪些操作会触发重新布局&#x2F;重绘</li>
<li><strong>正确处理 JS 交互</strong> - 理解跨进程通信的开销</li>
<li><strong>调试 Web 问题</strong> - 知道从哪里找问题根源</li>
<li><strong>做出架构决策</strong> - 理解 WebView 的能力边界</li>
</ol>
<p>WebKit 的代码质量非常高，是学习大型 C++ 项目架构的绝佳材料。希望这份文档能帮助你在 iOS 开发中更好地使用和调试 WebView！</p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul></div><div class="post-nav"><a class="next" href="/2021/12/30/2021year-end-summary/">2021年终总结</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://www.965.one"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.png"/></a><p>To be a better man.</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:admin@domain.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 15px;">随笔</a> <a href="/tags/%E4%BA%BA%E6%80%A7/" style="font-size: 15px;">人性</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Xcode/" style="font-size: 15px;">Xcode</a> <a href="/tags/OC/" style="font-size: 15px;">OC</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2026/01/12/WebKit%E6%9E%B6%E6%9E%84%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/">WebKit 内核架构深度分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/30/2021year-end-summary/">2021年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/07/10/WWDC21-ShangHai/">WWDC21上海场技术沙龙参与记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/12/2021%E4%B8%BD%E6%B1%9F5%E6%97%A5%E6%B8%B8/">2021丽江5日游</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/31/2020%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/">2020年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/26/%E6%88%91%E6%9C%89%E4%B8%89%E6%8A%8A%E5%88%80/">我有三把刀</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/08/fastlane%20integrated/">Fastlane自动上传beta包遇到的一些坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/21/%E6%9C%80%E8%BF%91%E7%8A%B6%E6%80%81%E6%84%9F%E6%83%B3/">Lorem ipsum</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/KBPhotoSelector/">KBPhotoSelector，一款iOS照片集选择、浏览、删除开源库</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/02/17%E5%B9%B45%E6%9C%882%E5%8F%B7%E9%9A%8F%E7%AC%94/">人，生来疾苦</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2026 <a href="/." rel="nofollow">四公子的剑.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>